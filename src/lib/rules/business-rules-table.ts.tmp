import type { GuiaType, ValidationError } from '@/types/tiss';
import type { ValidationRule, ValidationContext } from './rule-types';
import { isValidCPF, isValidCNPJ, isValidCNS, formatCPF, formatCNPJ, formatCNS } from './validators/document-validators';
import { isValidTISSDate, isDateInFuture, isDateAfterOrEqual, formatDateBR } from './validators/date-validators';
import { isValidUF, isValidConselhoProfissional, isValidTUSSFormat, getUFName, getConselhoProfissionalName, formatTUSSCode } from './validators/table-validators';

/**
 * Extrai todos os valores de um campo espec√≠fico de um objeto aninhado
 * Funciona com XMLs que t√™m namespaces (ans:, tiss:, etc) e estruturas aninhadas
 */
function extractFieldValues(obj: any, fieldName: string): string[] {
    const values: string[] = [];
    const searchTerm = fieldName.toLowerCase();
    let keysChecked = 0;
    let matchesFound = 0;

    console.log(`[extractFieldValues] üîç Procurando por: "${searchTerm}"`);

    function traverse(current: any, currentPath: string = '') {
        if (!current || typeof current !== 'object') return;

        // Se for array, itera sobre elementos
        if (Array.isArray(current)) {
            current.forEach((item, index) => traverse(item, `${currentPath}[${index}]`));
            return;
        }

        for (const key in current) {
            keysChecked++;

            // Remove namespace prefix para compara√ß√£o (ex: ans:cpf -> cpf)
            const cleanKey = key.replace(/^[^:]+:/, '').toLowerCase();

            // Verifica se o nome do campo corresponde
            if (cleanKey.includes(searchTerm)) {

                matchesFound++;
                console.log(`[extractFieldValues]   ‚úì MATCH! "${key}" (path: ${currentPath || 'root'})`);

                const value = current[key];

                // Se o valor √© string, adiciona
                if (typeof value === 'string' && value.trim()) {
                    console.log(`[extractFieldValues]     ‚Üí STRING: "${value}"`);
                    values.push(value.trim());
                }
                // Se o valor √© n√∫mero, converte COM PADDING se necess√°rio
                else if (typeof value === 'number') {
                    let strValue = String(value);

                    // CORRE√á√ÉO: CPF/CNPJ/CNS podem perder zeros √† esquerda quando parseados como n√∫mero
                    // Fazemos padding baseado no tamanho esperado para cada tipo de documento
                    if (cleanKey.includes('cpf') && strValue.length < 11) {
                        strValue = strValue.padStart(11, '0');
                        console.log(`[extractFieldValues]     ‚Üí NUMBER: ${value} ‚Üí PADDED CPF: "${strValue}"`);
                    } else if (cleanKey.includes('cnpj') && strValue.length < 14) {
                        strValue = strValue.padStart(14, '0');
                        console.log(`[extractFieldValues]     ‚Üí NUMBER: ${value} ‚Üí PADDED CNPJ: "${strValue}"`);
                    } else if (cleanKey.includes('cns') && strValue.length < 15) {
                        strValue = strValue.padStart(15, '0');
                        console.log(`[extractFieldValues]     ‚Üí NUMBER: ${value} ‚Üí PADDED CNS: "${strValue}"`);
                    } else {
                        console.log(`[extractFieldValues]     ‚Üí NUMBER: ${value}`);
                    }

                    values.push(strValue);
                }
                // Se o valor √© objeto com #text (formato do parser XML)
                else if (value && typeof value === 'object' && '#text' in value) {
                    const textValue = value['#text'];
                    if (typeof textValue === 'string' && textValue.trim()) {
                        console.log(`[extractFieldValues]     ‚Üí #TEXT: "${textValue}"`);
                        values.push(textValue.trim());
                    }
                }
                // Se o valor √© objeto, ainda traverse
                else if (value && typeof value === 'object') {
                    console.log(`[extractFieldValues]     ‚Üí OBJETO (continuando busca...)`);
                    traverse(value, `${currentPath}.${key}`);
                }
            } else {
                // Continua a busca em profundidade
                if (typeof current[key] === 'object' && current[key] !== null) {
                    traverse(current[key], `${currentPath}.${key}`);
                }
            }
        }
    }

    traverse(obj);

    console.log(`[extractFieldValues] üìä ${keysChecked} chaves, ${matchesFound} matches, ${values.length} valores`);

    return [...new Set(values)]; // Remove duplicatas
}

// ... (c√≥digo de CPF, CNPJ, CNS, DateFormat, DateLogic permanece o mesmo - vou adicionar apenas as novas regras ao final)

/**
 * Regra de valida√ß√£o de c√≥digo TUSS (procedimentos)
 * Valida formato dos c√≥digos de procedimentos da tabela TUSS
 */
export class TUSSCodeRule implements ValidationRule {
    id = 'tuss-code';
    name = 'Valida√ß√£o de C√≥digo TUSS';
    description = 'Valida formato dos c√≥digos de procedimentos TUSS';
    priority = 130;
    enabled = true;

    appliesTo(context: ValidationContext): boolean {
        // Aplica para guias que t√™m procedimentos
        return context.guiaType === 'tissGuiaSP_SADT' || 
               context.guiaType === 'tissGuiaConsulta' ||
               context.guiaType === 'tissGuiaOdontologia';
    }

    validate(context: ValidationContext): ValidationError[] {
        const errors: ValidationError[] = [];

        console.log(`\n========== TUSS CODE VALIDATION ==========`);

        // Busca c√≥digos de procedimento
        const procedureCodes = extractFieldValues(context.parsedXml, 'codigoprocedimento');

        console.log(`[TUSSCodeRule] Total de c√≥digos encontrados: ${procedureCodes.length}`);

        for (const code of procedureCodes) {
            if (!isValidTUSSFormat(code)) {
                console.log(`[TUSSCodeRule] ‚ùå C√≥digo TUSS inv√°lido: ${code}`);
                errors.push({
                    id: crypto.randomUUID(),
                    line: 0,
                    column: 0,
                    message: `C√≥digo TUSS com formato inv√°lido: ${code}`,
                    severity: 'warning',
                    code: 'TABLE001',
                    field: 'codigoProcedimento',
                    suggestion: `C√≥digo TUSS deve ter 8 d√≠gitos. Formato esperado: ${formatTUSSCode('12345678')}`,
                });
            } else {
                console.log(`[TUSSCodeRule] ‚úÖ Formato v√°lido: ${formatTUSSCode(code)}`);
            }
        }

        console.log(`===========================================\n`);
        return errors;
    }
}

/**
 * Regra de valida√ß√£o de c√≥digo de UF
 * Valida c√≥digos de Unidade da Federa√ß√£o contra tabela ANS
 */
export class UFCodeRule implements ValidationRule {
    id = 'uf-code';
    name = 'Valida√ß√£o de C√≥digo UF';
    description = 'Valida c√≥digos de UF contra tabela ANS';
    priority = 131;
    enabled = true;

    appliesTo(_context: ValidationContext): boolean {
        return true; // Aplica para todos
    }

    validate(context: ValidationContext): ValidationError[] {
        const errors: ValidationError[] = [];

        console.log(`\n========== UF CODE VALIDATION ==========`);

        // Busca c√≥digos de UF
        const ufCodes = extractFieldValues(context.parsedXml, 'uf');

        console.log(`[UFCodeRule] Total de UFs encontradas: ${ufCodes.length}`);

        for (const code of ufCodes) {
            if (!isValidUF(code)) {
                console.log(`[UFCodeRule] ‚ùå UF inv√°lida: ${code}`);
                errors.push({
                    id: crypto.randomUUID(),
                    line: 0,
                    column: 0,
                    message: `C√≥digo de UF inv√°lido: ${code}`,
                    severity: 'error',
                    code: 'TABLE002',
                    field: 'UF',
                    suggestion: `C√≥digo de UF deve estar na tabela ANS (01-53). Exemplos: 25 (Para√≠ba), 35 (S√£o Paulo), 53 (Distrito Federal)`,
                });
            } else {
                const ufName = getUFName(code);
                console.log(`[UFCodeRule] ‚úÖ UF v√°lida: ${code} (${ufName})`);
            }
        }

        console.log(`========================================\n`);
        return errors;
    }
}

/**
 * Regra de valida√ß√£o de Conselho Profissional
 * Valida c√≥digos de conselho profissional contra tabela ANS
 */
export class ConselhoProfissionalRule implements ValidationRule {
    id = 'conselho-profissional';
    name = 'Valida√ß√£o de Conselho Profissional';
    description = 'Valida c√≥digos de conselho profissional contra tabela ANS';
    priority = 132;
    enabled = true;

    appliesTo(_context: ValidationContext): boolean {
        return true; // Aplica para todos
    }

    validate(context: ValidationContext): ValidationError[] {
        const errors: ValidationError[] = [];

        console.log(`\n========== CONSELHO PROFISSIONAL VALIDATION ==========`);

        // Busca c√≥digos de conselho profissional
        const conselhoCodes = extractFieldValues(context.parsedXml, 'conselhoprofissional');

        console.log(`[ConselhoProfissionalRule] Total de conselhos encontrados: ${conselhoCodes.length}`);

        for (const code of conselhoCodes) {
            if (!isValidConselhoProfissional(code)) {
                console.log(`[ConselhoProfissionalRule] ‚ùå Conselho inv√°lido: ${code}`);
                errors.push({
                    id: crypto.randomUUID(),
                    line: 0,
                    column: 0,
                    message: `C√≥digo de Conselho Profissional inv√°lido: ${code}`,
                    severity: 'error',
                    code: 'TABLE003',
                    field: 'conselhoProfissional',
                    suggestion: `C√≥digo deve estar na tabela ANS (01-10). Exemplos: 06 (CRM), 08 (CRO), 09 (CRP)`,
                });
            } else {
                const conselhoName = getConselhoProfissionalName(code);
                console.log(`[ConselhoProfissionalRule] ‚úÖ Conselho v√°lido: ${code} (${conselhoName})`);
            }
        }

        console.log(`=====================================================\n`);
        return errors;
    }
}
